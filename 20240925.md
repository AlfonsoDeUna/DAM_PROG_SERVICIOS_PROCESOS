# 1. Gestión de procesos en Java - ProcessBuilder y Process

## Preparación y configuración de un proceso

### Modificar el comando en tiempo de ejecución
### Configuraciones adicionales de un proceso

##  Acceso al proceso una vez en ejecución

## Información de los procesos en Java

### Preparación y configuración de un proceso

En el paquete `java.lang` tenemos dos clases para la gestión de procesos:

- `java.lang.ProcessBuilder` [Referencia API Java](https://docs.oracle.com/javase/8/docs/api/java/lang/ProcessBuilder.html)
- `java.lang.Process` [Referencia API Java](https://docs.oracle.com/javase/8/docs/api/java/lang/Process.html)

Las instancias de `ProcessBuilder` gestionan los atributos de los procesos, mientras que las instancias de `Process` controlan la ejecución de esos mismos procesos cuando se ejecutan.

Antes de ejecutar un nuevo proceso, podemos configurar los parámetros de ejecución del mismo usando la clase `ProcessBuilder`.

`ProcessBuilder` es una clase auxiliar de la clase `Process`, que veremos más adelante, y se utiliza para controlar algunos parámetros de ejecución que afectarán al proceso. A través de la llamada al método `start()` se crea un nuevo proceso en el sistema con los atributos definidos en la instancia de `ProcessBuilder`.

```java
ProcessBuilder pb = new ProcessBuilder("CMD", "/C", "DIR");
Process p = pb.start();
```

Si llamamos varias veces al método `start()`, se crearán tantos nuevos procesos como llamadas hagamos, todos ellos con los mismos atributos.

La clase `ProcessBuilder` define un par de constructores:

```java
ProcessBuilder(List<String> command)
ProcessBuilder(String... command)
```

El funcionamiento de ambos es el mismo. En el primer constructor se pasa el comando a ejecutar y la lista de argumentos como una lista de cadenas. En el segundo constructor, el comando y sus argumentos se pasan a través de un número variable de cadenas (`String ...` es lo que en Java se llama varargs). La versión que utilicemos depende del formato en que tengamos los datos.

### Argumentos y parámetros

Si queremos lanzar un programa con parámetros (modificadores como `-h`, `/s`), el comando no puede ser pasado al constructor directamente como un único string; debe ser preprocesado para convertirlo en una lista.

```java
// Diferentes formas de pasar el comando a los constructores de ProcessBuilder
// 1ª forma: usando una cadena. Falla con parámetros
String command1 = "notepad.exe prueba1.txt";
ProcessBuilder pb = new ProcessBuilder(command1);

// 2ª forma: usando un array de cadenas. Funciona con parámetros
String[] command2 = {"cmd", "/c", "dir", "/o"};
ProcessBuilder pb = new ProcessBuilder(command2);

// 3ª forma: usando una cadena y dividiéndola para convertirla en una lista
String command3 = "c:/windows/system32/shutdown -s -t 0";
ProcessBuilder pb = new ProcessBuilder(command3.split("\s"));
```

### Apagar el sistema operativo

El comando `shutdown -s` apaga el sistema. En Windows, es necesario proporcionar la ruta completa al comando, por ejemplo `C:\Windows\System32\shutdown`.

Podemos usar como parámetros `-s` para apagar, `-r` para reiniciar, `-h` para hibernar y `-t` para indicar un tiempo de espera antes de apagar.

Referencia del comando shutdown de Windows.

#### **Actividad:** psp.activities.U2A1_Shutdowner

Crea un nuevo proyecto Java. Usando la línea de comandos, pide al usuario qué acción quiere realizar (apagar, reiniciar o suspender) y cuánto tiempo dejar antes de realizar la acción de apagado. Debe funcionar tanto en Windows como en Linux.

### Modificar el comando en tiempo de ejecución

Es posible cambiar, modificar y consultar el comando a posteriori con el método `command()`.

```java
command(List<String> command)
command(String... command)
```

Ejemplo para modificar el comando:

```java
String command = "java -jar install.jar -install";
ProcessBuilder pbuilder = new ProcessBuilder(command.split("\s"));
if (isWindows) {
    pbuilder.command().add(0, "cmd");
    pbuilder.command().add(1, "/c");
    pbuilder.command().add("c:/temp");
} else {
    pbuilder.command().add(0, "sh");
    pbuilder.command().add(1, "-c");
    pbuilder.command().add("/tmp");
}
pbuilder.start();
```

### Configuraciones adicionales de un proceso

Podemos establecer el directorio de trabajo y modificar las variables de entorno con los métodos `directory()` y `environment()`.

```java
pbuilder.directory(new File(System.getProperty("user.home")));

Map<String, String> environment = pbuilder.environment();
String systemPath = environment.get("path") + ";c:/users/public";
environment.replace("path", systemPath);
environment.put("GREETING", "Hola Mundo");
```

#### **Actividad:** psp.activities.U2A2_DirectorioTrabajo

Crea un proyecto Java que ejecute el comando `ls` o `dir`, modifique el valor de la propiedad `user.dir`, y cambie el directorio de trabajo dependiendo del sistema operativo.

---

## Acceso al proceso una vez en ejecución

La clase `Process` es abstracta y contiene la información del proceso en ejecución.

#### **Actividad:** psp.activities.U2A3_ExitValue

Crea un proyecto Java que ejecute varios comandos y obtenga el código de finalización de cada uno.

---

## Información de los procesos en Java

Podemos obtener información sobre un proceso usando los métodos de `java.lang.ProcessHandle.Info`.

```java
ProcessHandle processHandle = ProcessHandle.current();
ProcessHandle.Info processInfo = processHandle.info();

System.out.println("PID: " + processHandle.pid());
System.out.println("Arguments: " + processInfo.arguments());
System.out.println("Command: " + processInfo.command());
System.out.println("Instant: " + processInfo.startInstant());
System.out.println("Total CPU duration: " + processInfo.totalCpuDuration());
System.out.println("User: " + processInfo.user());
```

También podemos obtener información del proceso hijo:

```java
Process process = processBuilder.inheritIO().start();
ProcessHandle childProcessHandle = process.toHandle();
ProcessHandle.Info childProcessInfo = childProcessHandle.info();
```
